# .github/workflows/update-data.yml

name: Update Macro Data

# 1. ì–¸ì œ ì‹¤í–‰í•  ê²ƒì¸ê°€?
on:
  # (ì˜µì…˜ 1) ë§¤ì¼ 08:00 UTC (í•œêµ­ ì‹œê°„ ì˜¤í›„ 5ì‹œ)ì— ìë™ìœ¼ë¡œ ì‹¤í–‰
  schedule:
    - cron: '0 8 * * *'
  
  # (ì˜µì…˜ 2) ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ Actions íƒ­ì— ë²„íŠ¼ ì¶”ê°€
  workflow_dispatch:

# 2. ë¬´ìŠ¨ ì‘ì—…ì„ í•  ê²ƒì¸ê°€?
jobs:
  update-cape-file:
    runs-on: ubuntu-latest # ì‘ì—… í™˜ê²½
    
    steps:
      # 1. ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (git checkout)
      - name: Check out repository
        uses: actions/checkout@v4

      # 2. R ì–¸ì–´ í™˜ê²½ ì„¤ì •
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'latest' # ìµœì‹  R ë²„ì „ ì‚¬ìš©

      # 3. R íŒ¨í‚¤ì§€ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages:
            any::tidyverse
            any::lubridate
            any::httr
            any::rvest
            any::Quandl
            any::readr

      # 4. R ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (API í‚¤ ì£¼ì…)
      - name: Run R script to fetch data
        env:
          # GitHub Secretì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì£¼ì…
          QUANDL_API_KEY: ${{ secrets.QUANDL_API_KEY }}
        run: Rscript update_cape.R # 1ë‹¨ê³„ì—ì„œ ë§Œë“  R ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

      # 5. ë³€ê²½ëœ íŒŒì¼ ì»¤ë°‹í•˜ê¸°
      - name: Commit updated file
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ“ˆ Auto-update Shiller CAPE data"
          file_pattern: shiller_cape.csv # ì´ íŒŒì¼ì— ë³€ê²½ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹
          commit_user_name: "GitHub Action Bot"
          commit_user_email: "actions@github.com"
          commit_author: "GitHub Action Bot <actions@github.com>"
          
