# .github/workflows/update-data.yml
# (Shiller CAPE ë°ì´í„°ë§Œ ìë™ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤)

name: Update Macro Data (Shiller CAPE Only)

on:
  schedule:
    - cron: '0 8 * * *'  # ë§¤ì¼ 08:00 UTCì— ì‹¤í–‰
  workflow_dispatch:   # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

permissions:
  contents: write      # git pushë¥¼ ìœ„í•œ ì“°ê¸° ê¶Œí•œ

jobs:
  update-cape-file:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Check out repository
        uses: actions/checkout@v4

      # 2. R ì–¸ì–´ í™˜ê²½ ì„¤ì •
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'latest'

      # 3. R íŒ¨í‚¤ì§€ ì˜ì¡´ì„± ì„¤ì¹˜ (Shiller CAPEì— í•„ìš”í•œ ê²ƒë§Œ)
      - name: Install R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            any::tidyverse
            any::lubridate
            any::readr
            any::readxl
            any::rvest
            any::httr
            any::Quandl

      # --- 4. Shiller CAPE ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ---
      # (update_cape.Rì€ í˜¹ì‹œ ëª¨ë¥¼ í´ë°± ë¡œì§ì— Quandlì„ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤)
      - name: Run R script for Shiller CAPE
        env:
          QUANDL_API_KEY: ${{ secrets.QUANDL_API_KEY }}
        run: Rscript update_cape.R 

      # --- 5. ë³€ê²½ëœ íŒŒì¼ ì»¤ë°‹ ë° í‘¸ì‹œ ---
      - name: Commit updated file (CAPE Only)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ“ˆ Auto-update Shiller CAPE data"
          file_pattern: shiller_cape.csv # CAPE íŒŒì¼ë§Œ ì»¤ë°‹
          commit_user_name: "GitHub Action Bot"
          commit_user_email: "actions@github.com"
          commit_author: "GitHub Action Bot <actions@github.com>"
